{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chat Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    body { background-color: #f5f5f5; }
    .sidebar { height: 90vh; overflow-y: auto; border-right: 1px solid #ddd; background: #fff; }
    .chat-window { height: 75vh; overflow-y: auto; background: #f8f9fa; padding: 16px; border-radius: 6px; }
    .msg-sent { text-align: right; margin-bottom: 12px; }
    .msg-recv { text-align: left; margin-bottom: 12px; }
    .bubble { display: inline-block; padding: 10px 14px; border-radius: 14px; max-width: 70%; word-wrap: break-word; }
    .bubble.sent { background: #dcf8c6; }
    .bubble.recv { background: #fff; border: 1px solid #eee; }
    .chat-image { max-width: 250px; border-radius: 10px; display: block; margin-top: 8px; }
  </style>
</head>
<body>

<h1 class="text-center py-2">SM SQUARE CREDIT SERVICES PRIVATE LIMITED</h1>

<div class="container-fluid">
  <div class="row">

    <!-- LEFT SIDE CONTACTS -->
    <div class="col-3 sidebar p-3">
      <h5>Contacts</h5>
      <input id="contactSearch" class="form-control mb-2" placeholder="Search number or name">

      <ul id="contactList" class="list-group">
        <li class="list-group-item">Loading...</li>
      </ul>
    </div>

    <!-- RIGHT SIDE CHAT PANEL -->
    <div class="col-9 p-3">
      <div id="chatHeader" class="mb-2"><strong>Select a contact</strong></div>

      <div id="chatWindow" class="chat-window mb-3">
        <div id="emptyHint" class="text-muted">No conversation selected.</div>
      </div>

      <!-- MESSAGE SENDER -->
      <div id="composer" style="display:none;">
        <div class="input-group mb-2">
          <input id="messageInput" type="text" class="form-control" placeholder="Type a message...">

          <input id="mediaInput" type="file" class="form-control"
            accept="image/*,video/*,audio/*,application/pdf,application/msword,
            application/vnd.openxmlformats-officedocument.wordprocessingml.document,
            application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">

          <button id="sendBtn" class="btn btn-success">Send</button>
        </div>

        <div id="filePreview" class="text-muted small"></div>
      </div>

    </div>
  </div>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>

(function() {

  let selectedMobile = null;

  window.CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // -------------------------------
  // AUTO REFRESH CONTACT LIST ONLY
  // -------------------------------
  setInterval(fetchContacts, 4000);

  function fetchContacts() {
    $.getJSON('/api/contacts/', function (data) {
      let list = data.contacts || [];

      // Sort by last message time
      list.sort((a, b) => new Date(b.last_time) - new Date(a.last_time));

      const ul = $("#contactList");
      ul.empty();

      if (!list.length) {
        ul.append('<li class="list-group-item">No contacts</li>');
        return;
      }

      list.forEach(item => {
        ul.append(`
          <li class="list-group-item contact-item ${item.mobile === selectedMobile ? 'active' : ''}" 
              data-mobile="${item.mobile}">

            ${item.mobile}

            ${item.unread > 0 
              ? `<span class="badge bg-danger float-end">${item.unread}</span>` 
              : ''}

          </li>
        `);
      });
    });
  }


  // ------------------------------
  // CONTACT SEARCH WORKING
  // ------------------------------
  $("#contactSearch").on("keyup", function () {
    let q = $(this).val().toLowerCase();
    $(".contact-item").each(function () {
      let mobile = $(this).data("mobile").toString();
      $(this).toggle(mobile.includes(q));
    });
  });


  // ------------------------------
  // WHEN USER CLICKS A CONTACT
  // ------------------------------
  $(document).on('click', '.contact-item', function () {
    selectedMobile = $(this).data('mobile');

    $('.contact-item').removeClass('active');
    $(this).addClass('active');

    $('#chatHeader').html(`<strong>${selectedMobile}</strong>`);
    $('#composer').show();

    loadChat(selectedMobile);
  });


  // ------------------------------
  // LOAD CHAT MESSAGES
  // ------------------------------
  function loadChat(mobile) {
    $.getJSON(`/api/messages/${mobile}/`, function(data) {
      renderMessages(data.messages || []);
    });
  }


  // ------------------------------
  // RENDER MESSAGES (TEXT + MEDIA)
  // ------------------------------
  function renderMessages(messages) {

    const container = $('#chatWindow');
    container.empty();

    if (!messages.length) {
      container.append('<div class="text-muted">No messages yet.</div>');
      return;
    }

    messages.forEach(msg => {
      let dt = new Date(msg.sent_at);
      let time = dt.toLocaleString();

      let content = "";

      switch (msg.content_type) {
        case "image":
          content = `<img src="${msg.media_file}" class="chat-image"><br>${msg.sent_text_message || ""}`;
          break;

        case "video":
          content = `<video controls width="260"><source src="${msg.media_file}"></video><br>${msg.sent_text_message || ""}`;
          break;

        case "audio":
          content = `<audio controls><source src="${msg.media_file}"></audio><br>${msg.sent_text_message || ""}`;
          break;

        case "document":
          content = `<a href="${msg.media_file}" target="_blank">ðŸ“„ Download</a><br>${msg.sent_text_message || ""}`;
          break;

        default:
          content = msg.sent_text_message || "";
      }

      const bubbleClass = msg.message_type === 'Sent' ? 'sent' : 'recv';
      const alignClass = msg.message_type === 'Sent' ? 'msg-sent' : 'msg-recv';

      container.append(`
        <div class="${alignClass}">
          <div class="bubble ${bubbleClass}">
            ${content}
            <div class="text-muted small">${time}</div>
          </div>
        </div>
      `);
    });

    container.scrollTop(container[0].scrollHeight);
  }


  // ------------------------------
  // FILE PREVIEW
  // ------------------------------
  $('#mediaInput').on('change', function(){
    const file = this.files[0];
    if (file) {
      $('#filePreview').text(`Selected: ${file.name}`);
    } else {
      $('#filePreview').text('');
    }
  });


  // ------------------------------
  // SEND MESSAGE
  // ------------------------------
  $('#sendBtn').on('click', function(){
    const text = $('#messageInput').val().trim();
    const file = $('#mediaInput')[0].files[0];

    if (!selectedMobile) {
      alert("Select a contact first!");
      return;
    }

    const formData = new FormData();
    formData.append("mobile", selectedMobile);
    formData.append("text", text);
    if (file) formData.append("media", file);

    $.ajax({
      url: '/api/send-reply/',
      method: 'POST',
      headers: { 'X-CSRFToken': window.CSRF_TOKEN },
      processData: false,
      contentType: false,
      data: formData,
      success: function() {
        $('#messageInput').val('');
        $('#mediaInput').val('');
        $('#filePreview').text('');

        loadChat(selectedMobile); // refresh chat after sending
      },
      error: function(err) {
        alert("Error sending message");
      }
    });
  });


})();
</script>

</body>
</html>
