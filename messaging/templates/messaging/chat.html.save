(venv) [ec2-user@ip-172-31-9-232 messaging]$ cat chat.html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chat Dashboard ‚Äî WhatsApp-like UI</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ====== WhatsApp-like UI ====== */
    :root{ --accent:#25D366; --accent-dark:#075E54; --muted:#6b7280; --bg:#e9f6f3; }
    html,body{height:100%; margin:0; padding:0; font-family: 'Segoe UI', Roboto, Arial, sans-serif;}
    body{background:#f3f4f6;color:#111}
    .container-fluid{padding:12px 14px}
    .sidebar{height:92vh;border-radius:10px;overflow:hidden;background:#fff;box-shadow:0 4px 14px rgba(10,10,10,0.04)}

    /* header */
    .sidebar-header{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;border-bottom:1px solid #f1f1f1}
    .sidebar-title{font-weight:700;font-size:18px}
    .toolbar-icons button{background:transparent;border:0;padding:6px;border-radius:8px}
    .toolbar-icons button:hover{background:#f5f5f5}

    .search-input{padding:10px}
    .search-input input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6}

    #contactListWrapper{height:calc(92vh - 140px);overflow:auto;padding-right:6px}
    .contact-item{cursor:pointer;padding:12px;border-bottom:1px solid #fafafa;display:flex;align-items:center;gap:12px}
    .contact-item:hover{background:#fbfffc}
    .contact-avatar{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#f0f6f5;color:var(--accent-dark);font-weight:700}
    .contact-main{flex:1;min-width:0}
    .contact-name{font-weight:600}
    .contact-last{font-size:13px;color:var(--muted);margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .unread-badge{font-size:12px;background:var(--accent);color:white;padding:4px 8px;border-radius:999px}

    /* chat area */
    .chat-col{padding-left:18px;height:92vh;display:flex;flex-direction:column}
    #chatHeader{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;background:#fff;border-bottom:1px solid #f1f1f1}
    #chatHeader .avatar{width:44px;height:44px;border-radius:50%;overflow:hidden}
    #chatHeader .meta{flex:1}
    #chatHeader .meta .name{font-weight:700}
    #chatHeader .meta .status{color:var(--muted);font-size:13px}

    .chat-window{
      flex:1;
      margin-top:12px;
      border-radius:8px;
      background:#eaf7f3;
      padding:0;
      box-shadow:0 6px 18px rgba(9,30,66,0.03);
      overflow:hidden;
    }

    /* FIX: increase chat viewport height and remove horizontal scroll */
    .chat-viewport{
      /* more vertical space so chat feels roomy */
      height: calc(100vh - 180px) !important;
      overflow-y:auto;
      overflow-x:hidden !important;
      padding:20px;
      position:relative;
      box-sizing:border-box;
    }

    /* Ensure wrappers never overflow horizontally */
    #messagesVirtual > div{
      max-width:100% !important;
      overflow-x:hidden !important;
      box-sizing:border-box;
    }

    .msg-row{display:flex;margin-bottom:14px}
    .msg-row.recv{justify-content:flex-start}
    .msg-row.sent{justify-content:flex-end}

    .bubble{
      display:inline-block;
      padding:10px 14px;
      border-radius:12px;
      max-width:85% !important; /* wider bubbles for readability */
      line-height:1.25;
      box-shadow:0 1px 0 rgba(0,0,0,0.02);

      /* FIX long text overflow */
      word-wrap:break-word;
      overflow-wrap:break-word;
      white-space:pre-wrap;
      box-sizing:border-box;
    }

    .bubble.sent{background:#dcf8c6;border-top-right-radius:4px}
    .bubble.recv{background:#fff;border:1px solid #f1f1f1;border-top-left-radius:4px}

    .bubble .meta{display:flex;align-items:center;justify-content:flex-end;gap:6px;margin-top:6px;font-size:12px;color:var(--muted)}
    .tick{font-size:13px;vertical-align:middle}

    /* Limit image/video/audio sizes so they don't dominate the chat pane */
    .chat-image, .chat-video, .chat-audio{
      max-width:260px !important;
      width:auto;
      height:auto !important;
      border-radius:8px;
      display:block;
      cursor:zoom-in;
    }

    /* composer */
    .composer-wrap{display:flex;align-items:center;gap:8px;padding:12px;border-top:1px solid #eee;background:#fff}
    .composer-input{flex:1;display:flex;align-items:center;gap:8px;background:#fff;padding:8px;border-radius:999px;border:1px solid #e6e6e6}
    .composer-input input{border:0;outline:0;width:100%;padding:6px}
    .icon-btn{background:transparent;border:0;padding:6px;border-radius:50%}

    /* media modal */
    .media-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:2000;visibility:hidden;opacity:0;transition:opacity .18s, visibility .18s}
    .media-modal.show{visibility:visible;opacity:1}
    .media-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.75)}
    .media-content{position:relative;max-width:92vw;max-height:92vh;z-index:2001}
    .media-content img, .media-content video{max-width:100%;max-height:100%;border-radius:8px}
    .media-close{position:absolute;top:-36px;right:-6px;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:999px;color:white;cursor:pointer}

    @media(max-width:900px){.col-3{display:none}.chat-col{padding-left:12px}}
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">

      <!-- SIDEBAR -->
      <div class="col-3">
        <div class="sidebar">
          <div class="sidebar-header">
            <div class="sidebar-title">Chats</div>
            <div class="toolbar-icons">
              <button title="New chat">‚úé</button>
              <button title="Menu">‚ãØ</button>
            </div>
          </div>

          <div class="search-input">
            <input id="contactSearch" class="form-control" placeholder="Search or start a new chat">
          </div>

          <div id="contactListWrapper">
            <div id="contactListVirtual" style="position:relative;"></div>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="col-9 chat-col">
        <div id="chatHeader">
          <div class="avatar" id="headerAvatar"><img id="headerAvatarImg" src="" alt="" style="width:44px;height:44px;border-radius:50%;object-fit:cover"></div>
          <div class="meta"><div class="name" id="headerName"><strong>Select a contact</strong></div><div class="status" id="headerStatus"></div></div>
          <div class="actions" style="display:flex;gap:8px">
            <button class="icon-btn" title="Video">üìπ</button>
            <button class="icon-btn" title="Call">üìû</button>
            <button class="icon-btn" title="Search">üîç</button>
          </div>
        </div>

        <div class="chat-window">
          <div id="chatViewport" class="chat-viewport">
            <div id="messagesVirtual"></div>
          </div>
        </div>

        <div id="pagination" class="mt-2"></div>

        <div id="composer" class="composer-wrap" style="display:none;">
          <button id="emojiBtn" class="icon-btn">üòä</button>
          <div class="composer-input">
            <input id="messageInput" type="text" placeholder="Type a message...">
            <input id="mediaInput" type="file" accept="image/*,video/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx" style="display:none;">
            <button id="attachBtn" class="icon-btn">üìé</button>
          </div>
          <button id="sendBtn" class="btn btn-success">Send</button>
        </div>

        <div id="filePreview" class="text-muted small mt-1"></div>
        <div id="typingStatus" class="typing-indicator"></div>

      </div><!-- chat-col ends -->
    </div>
  </div>

  <!-- Media modal -->
  <div id="mediaModal" class="media-modal" aria-hidden="true">
    <div class="media-backdrop" data-close="1"></div>
    <div class="media-content">
      <button id="mediaClose" class="media-close">‚úñ</button>
      <div id="mediaInner"></div>
    </div>
  </div>

<script>
  (function(){
  // === CONFIG & STATE ===
  const PAGE_SIZE = 200;
  const CONTACT_ROW_HEIGHT = 76;
  const CSRF = document.querySelector('meta[name="csrf-token"]').content;

  let ws = null, wsConnected = false;
  let contactData = [];
  let selectedMobile = null;
  let messages = [];
  let msgMap = new Map();
  let loadedPages = new Set();
  let totalPages = 1;

  // virtualization
  let messageHeights = [];
  let messageOffsets = [];
  let estimatedHeight = 90;

  // DOM refs
  const contactWrapper = document.getElementById("contactListWrapper");
  const contactVirtual = document.getElementById("contactListVirtual");
  const chatViewport = document.getElementById("chatViewport");
  const messagesVirtual = document.getElementById("messagesVirtual");
  const headerName = document.getElementById("headerName");
  const headerAvatarImg = document.getElementById("headerAvatarImg");
  const composer = document.getElementById("composer");

  // ==== IndexedDB Helpers ====
  const DB_NAME = "chat_dashboard_db_v2";
  const DB_VERSION = 1;
  let dbPromise = null;

  function openDb(){
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve,reject)=>{
      const rq = indexedDB.open(DB_NAME, DB_VERSION);
      rq.onupgradeneeded = e=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains('contacts')) db.createObjectStore('contacts',{keyPath:'mobile'});
        if(!db.objectStoreNames.contains('messages')) db.createObjectStore('messages',{keyPath:'key'});
      };
      rq.onsuccess = e=>resolve(e.target.result);
      rq.onerror = e=>reject(e.target.error);
    });
    return dbPromise;
  }

  async function idbPut(store, data){
    try{
      const db = await openDb();
      return new Promise((res, rej)=>{
        const tx = db.transaction(store, 'readwrite');
        tx.objectStore(store).put(data);
        tx.oncomplete = ()=>res(true);
        tx.onerror = ()=>rej(tx.error);
      });
    }catch(e){ return false; }
  }

  async function idbGet(store, key){
    try{
      const db = await openDb();
      return new Promise((res, rej)=>{
        const tx = db.transaction(store, 'readonly');
        const rq = tx.objectStore(store).get(key);
        rq.onsuccess = ()=>res(rq.result);
        rq.onerror = ()=>rej(rq.error);
      });
    }catch(e){ return null; }
  }

  async function idbGetAll(store){
    try{
      const db = await openDb();
      return new Promise((res, rej)=>{
        const tx = db.transaction(store, 'readonly');
        const rq = tx.objectStore(store).getAll();
        rq.onsuccess = ()=>res(rq.result||[]);
        rq.onerror = ()=>rej(rq.error);
      });
    }catch(e){ return []; }
  }

  // ==== WEBSOCKET ====
  function sendWS(obj){
    if (ws && ws.readyState === WebSocket.OPEN){
      ws.send(JSON.stringify(obj));
    }
  }

  function connectWS(){
    if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) return;
    const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(scheme + '://' + location.host + '/ws/chat/');

    ws.onopen = ()=>{
      wsConnected = true;
      sendWS({ type:'get_contacts' });
    };

    ws.onmessage = e=>{
      try{
        handleWS(JSON.parse(e.data));
      } catch(err){}
    };

    ws.onclose = ()=>{ wsConnected = false; setTimeout(connectWS, 800); };
    ws.onerror = ()=>{ wsConnected = false; };
  }
  connectWS();

  // ==== CONTACT LIST ====
  function formatLastMessage(c){
    if (!c || !c.last_msg) return "";

    let msg = c.last_msg;
    if (msg.length > 60) msg = msg.slice(0,57) + '...';

    if (c.last_type === "Sent") {
      if (c.last_status === "Read") return `‚úî‚úî ${msg}`;
      if (c.last_status === "Delivered") return `‚úî‚úî ${msg}`;
      return `‚úî ${msg}`;
    }
    return msg;
  }

  function renderVirtualContacts(){
    const scrollTop = contactWrapper.scrollTop;
    const viewportH = contactWrapper.clientHeight;
    const startIdx = Math.floor(scrollTop / CONTACT_ROW_HEIGHT);
    const endIdx = startIdx + Math.ceil(viewportH / CONTACT_ROW_HEIGHT) + 6;

    contactVirtual.innerHTML = '';
    contactVirtual.style.height = (contactData.length * CONTACT_ROW_HEIGHT) + 'px';

    for (let i = startIdx; i < endIdx && i < contactData.length; i++){
      const c = contactData[i];
      const row = document.createElement('div');
      row.className = 'contact-item';
      row.dataset.mobile = c.mobile;
      row.style.cssText = `position:absolute; top:${i * CONTACT_ROW_HEIGHT}px; left:0; right:0; height:${CONTACT_ROW_HEIGHT}px; padding:8px 10px;`;

      row.innerHTML = `
        <div class="contact-avatar">${(c.mobile||'NA').slice(-2)}</div>
        <div class="contact-main">
          <div class="contact-name">${c.mobile}</div>
          <div class="contact-last">${formatLastMessage(c)}</div>
        </div>
        ${c.unread ? `<div><span class="unread-badge">${c.unread}</span></div>` : ''}
      `;
      if (selectedMobile === c.mobile) row.style.background = '#eefaf1';
      contactVirtual.appendChild(row);
    }
  }
  contactWrapper.addEventListener('scroll', renderVirtualContacts);

  async function saveContactsToIdb(list){
    for (const c of list) await idbPut('contacts', c);
  }

  async function loadContactsFromIdb(){
    const all = await idbGetAll('contacts');
    if (all.length){
      all.sort((a,b)=> new Date(b.last_time||0) - new Date(a.last_time||0));
      contactData = all;
      renderVirtualContacts();
    }
  }

  function upsertContact(c, moveToTop=false){
    const idx = contactData.findIndex(x=>x.mobile === c.mobile);
    if (idx > -1){
      contactData[idx] = { ...contactData[idx], ...c };
      if (moveToTop){
        const moved = contactData.splice(idx,1)[0];
        contactData.unshift(moved);
      }
    } else {
      if (moveToTop) contactData.unshift(c);
      else contactData.push(c);
    }
    renderVirtualContacts();
    idbPut('contacts', c);
  }

  // ==== MESSAGE VIRTUALIZATION ====
  function ensureArrays(len){
    while(messageHeights.length < len) messageHeights.push(null);
    while(messageOffsets.length < len) messageOffsets.push(0);
  }

  function recomputeOffsets(){
    ensureArrays(messages.length);
    let top = 0;
    for (let i=0;i<messages.length;i++){
      messageOffsets[i] = top;
      const h = messageHeights[i] || estimatedHeight;
      top += h;
    }
    messagesVirtual.style.height = Math.max(top, chatViewport.clientHeight) + 'px';
  }

  function renderVisibleMessages(){
    recomputeOffsets();
    const scrollTop = chatViewport.scrollTop;
    const viewport = chatViewport.clientHeight;
    const total = messages.length;

    let firstIdx = 0;
    for (let i=0;i<total;i++){
      const bottom = messageOffsets[i] + (messageHeights[i] || estimatedHeight);
      if (bottom >= scrollTop - estimatedHeight*3){
        firstIdx = Math.max(0, i-1);
        break;
      }
    }

    let lastIdx = total-1;
    for (let i = firstIdx; i < total; i++){
      if (messageOffsets[i] > scrollTop + viewport + estimatedHeight*3){
        lastIdx = Math.max(0, i-1);
        break;
      }
    }

    messagesVirtual.innerHTML = '';

    for (let i=firstIdx; i<=lastIdx; i++){
      const m = messages[i];
      if (!m) continue;

      const top = messageOffsets[i];
      const wrap = document.createElement('div');
      wrap.style.position='absolute';
      wrap.style.top = top + 'px';
      wrap.style.width='100%';
      wrap.dataset.index = i;

      const row = document.createElement('div');
      row.className = m.message_type === 'Sent' ? 'msg-row sent' : 'msg-row recv';

      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (m.message_type === 'Sent' ? 'sent' : 'recv');

      const dataId = m.message_id || m.id || ('local_'+(m.id||Date.now()));
      bubble.dataset.id = dataId;
      bubble.dataset.index = i;

      let content = '';
      if (m.content_type === 'image'){
        // add onclick to open modal
        const src = m.media_file || '';
        content = `<img class="chat-image" src="${src}" onclick="(function(){ try{ openMediaModal('${src.replace(/'/g,"\\'")}','image'); } catch(e){} })()">`;
      } else if (m.content_type === 'video'){
        const src = m.media_file || '';
        content = `<video class="chat-video" controls preload="metadata" onclick="(function(){ try{ openMediaModal('${src.replace(/'/g,"\\'")}','video'); } catch(e){} })()" src="${src}"></video>`;
      } else if (m.content_type === 'audio'){
        const src = m.media_file || '';
        content = `<audio class="chat-audio" controls src="${src}"></audio>`;
      } else if (m.content_type === 'document'){
        content = `<a href="${m.media_file}" target="_blank">üìÑ Document</a>`;
      } else {
        content = (m.sent_text_message||'')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;');
      }

      const timeStr = m.sent_at ? new Date(m.sent_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';

      let ticks = '';
      if (m.message_type === 'Sent'){
        ticks = `<span class="tick" data-tid="${m.message_id||m.id||''}"></span>`;
      }

      let nameTag = "";
if (m.message_type === "Sent") {
    nameTag = m.sender_name ? ` (${m.sender_name})` : "";
}

bubble.innerHTML = `
    ${content}
    <div class="meta">
        ${timeStr} ${ticks}${nameTag}
    </div>
`;

      row.appendChild(bubble);
      wrap.appendChild(row);
      messagesVirtual.appendChild(wrap);
    }

    requestAnimationFrame(()=>{
      const nodes = messagesVirtual.children;
      let updated=false;

      for (const node of nodes){
        const idx = parseInt(node.dataset.index);
        const rect = node.getBoundingClientRect();
        if (!messageHeights[idx] || Math.abs(messageHeights[idx]-rect.height)>3){
          messageHeights[idx] = rect.height;
          updated = true;
        }
      }
      if (updated) recomputeOffsets();
      renderAllTicks();
    });
  }

  function renderTickElem(span, status){
    if (!span) return;
    if (status === 'Failed'){ span.textContent='‚úñ'; span.style.color='red'; return; }
    if (status === 'Sent'){ span.textContent='‚úî'; span.style.color=''; return; }
    if (status === 'Delivered'){ span.textContent='‚úî‚úî'; span.style.color='gray'; return; }
    if (status === 'Read'){ span.textContent='‚úî‚úî'; span.style.color='blue'; return; }
    span.textContent='';
  }

  function updateMessageStatus(msgId, status){
    const el = messagesVirtual.querySelector(`.tick[data-tid="${msgId}"]`);
    if (el){ renderTickElem(el, status); return; }

    for (let i=messages.length-1;i>=0;i--){
      const m = messages[i];
      if (m && m.message_id === msgId){
        m.status = status;
        renderVisibleMessages();
        break;
      }
    }
  }

  function renderAllTicks(){
    const nodes = messagesVirtual.querySelectorAll('.tick');
    nodes.forEach(t=>{
      const id = t.dataset.tid;
      const msg = messages.find(m=>m.message_id===id);
      if (msg) renderTickElem(t, msg.status||'Sent');
    });
  }

  function getMsgKey(m){
    return m.message_id || m.id || ('local_'+Date.now()+'_'+Math.random());
  }

  function appendMessage(m, moveToTop=true){
    const key = getMsgKey(m);
    if (msgMap.has(key)) return;
    msgMap.set(key,true);

    messages.push(m);
    messageHeights.push(null);

    requestAnimationFrame(()=>renderVisibleMessages());

    const nearBottom = (chatViewport.scrollHeight - chatViewport.scrollTop - chatViewport.clientHeight) < 200;
    if (nearBottom){
      setTimeout(()=> chatViewport.scrollTop = chatViewport.scrollHeight, 40);
    }

    const idbKey = `${selectedMobile}::append::${key}`;
    idbPut('messages', { key:idbKey, page:null, messages:[m] });

    if (moveToTop){
      upsertContact({
        mobile:m.mobile,
        last_time:m.sent_at,
        last_msg:m.sent_text_message,
        last_type:m.message_type,
        last_status:m.status,
        unread: m.message_type==='Received'?1:0
      }, true);
    }
  }

  function prependMessages(list){
    const newMsgs=[];
    for (const m of list){
      const key = getMsgKey(m);
      if (!msgMap.has(key)){
        msgMap.set(key,true);
        newMsgs.push(m);
      }
    }

    if (!newMsgs.length) return;

    messages = newMsgs.concat(messages);
    messageHeights = new Array(newMsgs.length).fill(null).concat(messageHeights);

    renderVisibleMessages();

    chatViewport.scrollTop = newMsgs.length * estimatedHeight;
  }

  async function saveMessagesPageToIdb(m,page,list){
    const key = `${m}::page::${page}`;
    await idbPut('messages', { key, page, messages:list });
  }

  async function loadMessagesPageFromIdb(m,page){
    const key = `${m}::page::${page}`;
    const data = await idbGet('messages', key);
    return data ? data.messages : null;
  }

  async function hydrateMessagesFromIdb(m){
    const first = await loadMessagesPageFromIdb(m,1);
    if (first && first.length){
      messages = first.slice();
      msgMap.clear();

      for (const x of messages) msgMap.set(getMsgKey(x), true);

      messageHeights = new Array(messages.length).fill(null);
      renderVisibleMessages();

      setTimeout(()=>chatViewport.scrollTop = chatViewport.scrollHeight, 20);
      return true;
    }
    messages=[]; msgMap.clear(); messageHeights=[]; messageOffsets=[];
    return false;
  }

  // ==== HANDLE WEBSOCKET EVENTS ====
  async function handleWS(d){
    if (!d || !d.type) return;

    if (d.type === 'contacts.list'){
      contactData = d.contacts || [];
      contactData.sort((a,b)=> new Date(b.last_time||0) - new Date(a.last_time||0));
      renderVirtualContacts();
      saveContactsToIdb(contactData);
    }

    else if (d.type === 'messages.page'){
      if (d.mobile !== selectedMobile) return;

      const page = d.meta?.page || 1;
      totalPages = d.meta?.total_pages || totalPages;

      const list = d.messages || [];
      if (page === 1){
        messages = list.slice();
        msgMap.clear();

        for (const m of messages) msgMap.set(getMsgKey(m), true);
        messageHeights = new Array(messages.length).fill(null);

        renderVisibleMessages();
        setTimeout(()=> chatViewport.scrollTop = chatViewport.scrollHeight, 30);
      } else {
        prependMessages(list.sort((a,b)=> new Date(a.sent_at) - new Date(b.sent_at)));
      }

      loadedPages.add(page);
      saveMessagesPageToIdb(selectedMobile, page, list);
    }

    // ====== NEW MESSAGE ======
    else if (d.type === 'new.message'){
      const m = d.message;
      if (!m) return;

      // === OUTGOING SENT MESSAGE ===
      if (m.message_type === "Sent"){

        // Update ticks inside chat
        updateMessageStatus(m.message_id, m.status);

        // Update sidebar (IMPORTANT)
        upsertContact(
          {
            mobile: m.mobile,
            last_time: m.sent_at,
            last_msg: m.sent_text_message,
            last_type: m.message_type,
            last_status: m.status
          },
          true
        );

        // Replace optimistic bubble with server bubble
        for (let i=messages.length-1;i>=0;i--){
          const it = messages[i];
          if (it &&
              it.message_type==='Sent' &&
              (!it.message_id || it.message_id==="") &&
              it.sent_text_message === m.sent_text_message)
          {
            messages[i] = { ...it, ...m };
            renderVisibleMessages();
            break;
          }
        }
        return;
      }

      // === INCOMING MESSAGE ===
      upsertContact(
        {
          mobile:m.mobile,
          last_time:m.sent_at,
          last_msg:m.sent_text_message,
          last_type:m.message_type,
          last_status:m.status,
          unread:1
        },
        true
      );

      if (selectedMobile === m.mobile){
        appendMessage(m, false);
      }
    }

    // ====== TICK UPDATES ======
    else if (d.type === 'delivery.update'){
      updateMessageStatus(d.message_id, d.status);

      for (let i=messages.length-1;i>=0;i--){
        if (messages[i] && messages[i].message_id===d.message_id){
          messages[i].status = d.status;
          break;
        }
      }

      // Update contact list ticks
      upsertContact(
        {
          mobile:d.mobile,
          last_status:d.status,
          last_time:new Date().toISOString()
        },
        false
      );

      renderVisibleMessages();
    }

    else if (d.type === 'typing'){
      if (d.mobile === selectedMobile){
        document.getElementById('typingStatus').textContent = d.state ? 'Typing‚Ä¶' : '';
      }
    }

    else if (d.type === 'media.progress'){
      if (d.mobile === selectedMobile){
        document.getElementById('filePreview').textContent =
            `Uploading ${d.filename}: ${d.progress}%`;
      }
    }
  }

  // ==== CONTACT SELECT ====
  contactVirtual.addEventListener('click', (e)=>{
    let n = e.target;
    while(n && n !== contactVirtual){
      if (n.dataset.mobile){
        onSelectContact(n.dataset.mobile);
        return;
      }
      n = n.parentNode;
    }
  });

  async function onSelectContact(m){
    selectedMobile = m;

    Array.from(contactVirtual.children).forEach(x=>{
      x.style.background = x.dataset.mobile===m ? '#eefaf1' : '';
    });

    headerName.innerHTML = `<strong>${m}</strong>`;
    composer.style.display = 'flex';

    messages = [];
    msgMap.clear();
    messageHeights=[];
    messageOffsets=[];
    loadedPages.clear();
    totalPages=1;

    await hydrateMessagesFromIdb(m);

    sendWS({type:'join', mobile:m});
    sendWS({type:'mark_read', mobile:m});
    sendWS({type:'get_messages', mobile:m, page:1, page_size:PAGE_SIZE});
  }

  // ==== SCROLL FOR PAGINATION ====
  chatViewport.addEventListener('scroll', async ()=>{
    renderVisibleMessages();

    if (chatViewport.scrollTop < estimatedHeight*6 && selectedMobile){
      let nextPage = loadedPages.size ? Math.max(...loadedPages)+1 : 2;
      if (nextPage > totalPages) return;

      const cached = await loadMessagesPageFromIdb(selectedMobile, nextPage);
      if (cached && cached.length){
        prependMessages(cached);
        loadedPages.add(nextPage);
        return;
      }
      sendWS({ type:'get_messages', mobile:selectedMobile, page:nextPage, page_size:PAGE_SIZE });
    }
  });

  // ==== CONTACT SEARCH ====
  document.getElementById("contactSearch").addEventListener("input", e=>{
    const q = e.target.value.trim();
    sendWS({ type:"search_contacts", q });
  });

  // ==== SEND MESSAGE ====
  document.getElementById('sendBtn').addEventListener('click', ()=>{
    if (!selectedMobile) return alert('Select a contact');

    const text = document.getElementById('messageInput').value.trim();
    const file = document.getElementById('mediaInput').files[0];

    // file upload
    if (file){
      const fd = new FormData();
      fd.append('mobile', selectedMobile);
      fd.append('text', text);
      fd.append('media', file);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/api/send-reply/');
      xhr.setRequestHeader('X-CSRFToken', CSRF);

      xhr.upload.onprogress = e=>{
        if (e.lengthComputable){
          const pct = Math.round(e.loaded / e.total * 100);
          sendWS({ type:'media.progress', mobile:selectedMobile, progress:pct, filename:file.name });
        }
      };

      xhr.onload = ()=>{
        document.getElementById('messageInput').value='';
        document.getElementById('mediaInput').value='';
      };

      xhr.onerror = ()=>alert('Upload failed');
      xhr.send(fd);
      return;
    }

    if (text){
      sendWS({type:'send_message', mobile:selectedMobile, text, content_type:'text'});
      document.getElementById('messageInput').value='';

      // Optimistic bubble
      const temp = {
        id:'local_'+Date.now(),
        mobile:selectedMobile,
        sent_text_message:text,
        message_type:'Sent',
        content_type:'text',
        sent_at:new Date().toISOString(),
        status:'Sent'
      };
      appendMessage(temp, true);
    }
  });

  // ==== ATTACH ====
  document.getElementById('attachBtn').onclick = ()=> document.getElementById('mediaInput').click();
  document.getElementById('mediaInput').onchange = ()=>{
    const f = document.getElementById('mediaInput').files[0];
    document.getElementById('filePreview').textContent = f ? `Ready: ${f.name}` : '';
  };

  // ==== TYPING ====
  let typingTimer=null;
  document.getElementById('messageInput').addEventListener('input', ()=>{
    if (!selectedMobile) return;
    sendWS({type:'typing', mobile:selectedMobile, state:true});
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=>{
      sendWS({type:'typing', mobile:selectedMobile, state:false});
    }, 800);
  });

  // ==== MEDIA MODAL ====
  function openMediaModal(src, type){
    const modal = document.getElementById('mediaModal');
    const inner = document.getElementById('mediaInner');
    inner.innerHTML = '';

    if (!src) return;
    if (type === 'video'){
      inner.innerHTML = `<video src="${src}" controls style="max-width:100%"></video>`;
    } else {
      inner.innerHTML = `<img src="${src}" style="max-width:100%">`;
    }

    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }

  function closeMediaModal(){
    const modal = document.getElementById('mediaModal');
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    document.getElementById('mediaInner').innerHTML='';
  }

  document.getElementById('mediaClose').onclick = closeMediaModal;
  document.querySelector('.media-backdrop').onclick = closeMediaModal;
  document.addEventListener('keydown', e=>{ if (e.key==='Escape') closeMediaModal(); });

  // ==== INIT ====
  (async function init(){
    try{ await loadContactsFromIdb(); }catch(e){}
    sendWS({ type:'get_contacts' });
  })();

})();
</script>
</body>
</html>
(venv) [ec2-user@ip-172-31-9-232 messaging]$
