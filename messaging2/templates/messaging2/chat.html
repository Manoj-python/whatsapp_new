{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chat Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    body { background-color: #f5f5f5; }

    .sidebar {
      height: 92vh;
      overflow-y: auto;
      border-right: 1px solid #ddd;
      background: #fff;
    }

    .chat-window {
      height: 80vh;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 16px;
      border-radius: 6px;
    }

    .msg-sent { text-align: right; margin-bottom: 12px; }
    .msg-recv { text-align: left; margin-bottom: 12px; }

    .bubble {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 75%;
      word-wrap: break-word;
      font-size: 15px;
    }

    .bubble.sent { background: #dcf8c6; }
    .bubble.recv { background: #fff; border: 1px solid #eee; }

    .chat-image { max-width: 250px; margin-top: 6px; border-radius: 12px; }
    .chat-video, .chat-audio { margin-top: 6px; border-radius: 12px; }
  </style>
</head>

<body>

<h1 class="text-center py-2">padma sai holdings private limited</h1>

<div class="container-fluid">
  <div class="row">

    <!-- CONTACT LIST -->
    <div class="col-3 sidebar p-3">
      <h5>Contacts</h5>

      <input id="contactSearch" class="form-control mb-2" placeholder="Search number">

      <ul id="contactList" class="list-group">
        <li class="list-group-item">Loading...</li>
      </ul>
    </div>

    <!-- CHAT WINDOW -->
    <div class="col-9 p-3">
      <div id="chatHeader" class="mb-2"><strong>Select a contact</strong></div>

      <div id="chatWindow" class="chat-window mb-3">
        <div class="text-muted">No conversation selected.</div>
      </div>

      <!-- COMPOSER -->
      <div id="composer" style="display:none;">
        <div class="input-group mb-2">
          <input id="messageInput" type="text" class="form-control" placeholder="Type message...">
          <input id="mediaInput" type="file" class="form-control"
            accept="image/*,video/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx">
          <button id="sendBtn" class="btn btn-success">Send</button>
        </div>

        <div id="filePreview" class="text-muted small"></div>
      </div>
    </div>

  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
(function() {

  let selectedMobile = null;
  let searchText = "";
  let searchTimer = null;

  let lastContactsKey = "";
  let lastChatKey = "";

  window.CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  // Base64 1x1 placeholder (light gray) â€” never requires network
  const BASE64_FALLBACK = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAA1BMVEUAAP8gbYQyAAAAHklEQVR4nO3BMQEAAADCoPdPbQ8HFAAAAAAAAAAAAACwCzkgAAEdyq/QAAAAAElFTkSuQmCC";

  // =============================================
  // AUTO LOAD CONTACTS
  // =============================================
  setInterval(fetchContacts, 30000);
  fetchContacts();

  function fetchContacts() {

    if (searchText.length > 0) return;

    $.getJSON('/messaging2/api/contacts2/', function(data) {

      let contacts = data.contacts || [];
      const key = JSON.stringify(contacts.map(c => [c.mobile, c.last_time, c.unread]));

      if (key === lastContactsKey) return;
      lastContactsKey = key;

      const list = $("#contactList");
      list.empty();

      contacts.sort((a,b) => new Date(b.last_time) - new Date(a.last_time));

      if (!contacts.length) {
        list.append('<li class="list-group-item">No contacts</li>');
        return;
      }

      contacts.forEach(c => {
        list.append(`
          <li class="list-group-item contact-item ${selectedMobile === c.mobile ? 'active' : ''}"
              data-mobile="${c.mobile}">
            ${c.mobile}
            ${c.unread > 0 ? `<span class="badge bg-danger float-end">${c.unread}</span>` : ""}
          </li>
        `);
      });

      if (searchText.length > 0) filterContacts();
    });
  }

  // SEARCH
  $("#contactSearch").on("input", function() {
    searchText = $(this).val().toLowerCase();
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => filterContacts(), 250);
  });

  function filterContacts() {
    $(".contact-item").each(function() {
      let mob = ($(this).data("mobile") || "").toString().toLowerCase();
      $(this).toggle(mob.includes(searchText));
    });
  }

  // SELECT CONTACT
  $(document).on("click", ".contact-item", function() {

    selectedMobile = $(this).data("mobile");

    $("#contactSearch").val("");
    searchText = "";
    lastContactsKey = "";

    $(".contact-item").removeClass("active");
    $(this).addClass("active");

    $("#chatHeader").html(`<strong>${selectedMobile}</strong>`);
    $("#composer").show();

    loadChat(true);

    $.get(`/messaging2/api/mark-read/${selectedMobile}/`, function() {
      fetchContacts();
    });
  });

  // =============================================
  // AUTO REFRESH CHAT
  // =============================================
  setInterval(function() {
    if (selectedMobile) loadChat(false);
  }, 6000);

  // LOAD CHAT
  function loadChat(forceScroll) {

    if (!selectedMobile) return;

    $.getJSON(`/messaging2/api/messages/${selectedMobile}/`, function(data) {

      const messages = data.messages || [];
      const key = JSON.stringify(messages.map(m => [m.id, m.sent_at, m.sent_text_message, m.content_type]));

      if (!forceScroll && key === lastChatKey) return;
      lastChatKey = key;

      const container = $("#chatWindow");

      const userIsAtBottom =
        container.scrollTop() + container.height() >= container[0].scrollHeight - 50;

      container.empty();

      messages.forEach(msg => {

        let t = msg.sent_at ? new Date(msg.sent_at).toLocaleString() : "";
        let c = "";

        // ================================================
        // S3 PUBLIC MEDIA HANDLING (uses base64 fallback)
        // ================================================
        if (msg.content_type === "image") {
          c = `
            <img src="${msg.media_file}"
                 class="chat-image"
                 onerror="this.onerror=null;this.src='${BASE64_FALLBACK}';">
            <br>${msg.sent_text_message || ""}
          `;
        }
        else if (msg.content_type === "video") {
          c = `
            <video controls class="chat-video" width="260">
              <source src="${msg.media_file}">
            </video>
          `;
        }
        else if (msg.content_type === "audio") {
          c = `
            <audio controls class="chat-audio">
              <source src="${msg.media_file}">
            </audio>
          `;
        }
        else if (msg.content_type === "document") {
          c = `<a href="${msg.media_file}" target="_blank">ðŸ“„ Open Document</a>`;
        }
        else {
          c = msg.sent_text_message || "";
        }

        container.append(`
          <div class="${msg.message_type === 'Sent' ? 'msg-sent' : 'msg-recv'}">
            <div class="bubble ${msg.message_type === 'Sent' ? 'sent' : 'recv'}">
              ${c}
              <div class="text-muted small">${t}</div>
            </div>
          </div>
        `);
      });

      if (forceScroll || userIsAtBottom) {
        container.scrollTop(container[0].scrollHeight);
      }

    });
  }

  // FILE PREVIEW
  $("#mediaInput").on("change", function() {
    const f = this.files[0];
    $("#filePreview").text(f ? "Selected: " + f.name : "");
  });

  // SEND
  $("#sendBtn").on("click", function() {

    const text = $("#messageInput").val().trim();
    const file = $("#mediaInput")[0].files[0];

    if (!selectedMobile) return alert("Select a contact first!");

    let fd = new FormData();
    fd.append("mobile", selectedMobile);
    fd.append("text", text);
    if (file) fd.append("media", file);

    $.ajax({
      url: "/messaging2/api/send-reply/",
      method: "POST",
      headers: { "X-CSRFToken": window.CSRF_TOKEN },
      processData: false,
      contentType: false,
      data: fd,
      success: function() {

        $("#messageInput").val("");
        $("#mediaInput").val("");
        $("#filePreview").text("");

        loadChat(true);
      }
    });

  });

})();
</script>

</body>
</html>
