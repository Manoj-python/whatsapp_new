{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    .sidebar { height: 90vh; overflow-y: auto; border-right: 1px solid #ddd; }
    .chat-window { height: 75vh; overflow-y: auto; background: #f8f9fa; padding: 16px; border-radius: 6px; }
    .msg-sent { text-align: right; margin-bottom: 12px; }
    .msg-recv { text-align: left; margin-bottom: 12px; }
    .bubble { display: inline-block; padding: 10px 14px; border-radius: 14px; max-width: 70%; }
    .bubble.sent { background: #dcf8c6; }
    .bubble.recv { background: #fff; border: 1px solid #eee; }
    .chat-image, .chat-video, .chat-audio { max-width: 250px; border-radius: 10px; display: block; margin-top: 8px; }
    .chat-window::-webkit-scrollbar { width: 8px; }
    .chat-window::-webkit-scrollbar-thumb { background: #bbb; border-radius: 10px; }
  </style>
</head>
<body>
  <h1>padma sai holdings private limited</h1>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-3 sidebar p-3">
      <h5>Contacts</h5>
      <input id="contactSearch" class="form-control mb-2" placeholder="Search number or name">
      <ul id="contactList" class="list-group">
        {% for item in mobile_list %}
          <li class="list-group-item contact-item" data-mobile="{{ item.mobile }}">{{ item.mobile }}</li>
        {% empty %}
          <li class="list-group-item">No contacts yet</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Chat Area -->
    <div class="col-9 p-3">
      <div id="chatHeader" class="mb-2"><strong>Select a contact</strong></div>
      <div id="chatWindow" class="chat-window mb-3">
        <div id="emptyHint" class="text-muted">No conversation selected.</div>
      </div>

      <!-- Composer -->
      <div id="composer" style="display:none;">
        <div class="input-group mb-2">
          <input id="messageInput" type="text" class="form-control" placeholder="Type a message...">
          <input id="mediaInput" type="file" class="form-control" accept="image/*,video/*,audio/*,application/pdf,.doc,.docx,.xls,.xlsx">
          <button id="sendBtn" class="btn btn-primary">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function () {
  let selectedMobile = null;
  let pollInterval = null;
  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<"']/g, m => ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function renderMessages(messages) {
    const container = $('#chatWindow');
    container.empty();
    if (!messages.length) {
      container.append('<div class="text-muted">No messages yet.</div>');
      return;
    }
    messages.forEach(msg => {
      const dt = new Date(msg.sent_at);
      const time = dt.toLocaleString();
      let content = '';

      // Detect content type
      if (msg.content_type === "image" && msg.media_file)
        content = `<img src="${msg.media_file}" class="chat-image"><br>${escapeHtml(msg.sent_text_message)}`;
      else if (msg.content_type === "video" && msg.media_file)
        content = `<video controls class="chat-video"><source src="${msg.media_file}" type="video/mp4"></video>`;
      else if (msg.content_type === "audio" && msg.media_file)
        content = `<audio controls class="chat-audio"><source src="${msg.media_file}" type="audio/mpeg"></audio>`;
      else if (msg.content_type === "document" && msg.media_file) {
        const filename = msg.sent_text_message || msg.media_file.split('/').pop();
        content = `<a href="${msg.media_file}" target="_blank">ðŸ“„ ${escapeHtml(filename)}</a>`;
      } else {
        content = escapeHtml(msg.sent_text_message);
      }

      const bubbleClass = msg.message_type === 'Sent' ? 'sent' : 'recv';
      const alignClass = msg.message_type === 'Sent' ? 'msg-sent' : 'msg-recv';

      container.append(`
        <div class="${alignClass}">
          <div class="bubble ${bubbleClass}">
            ${content}
            <div class="text-muted small mt-1">${time}</div>
          </div>
        </div>
      `);
    });
    container.scrollTop(container[0].scrollHeight);
  }

  function fetchMessages(mobile) {
    $.getJSON(`/messaging2/api/messages/${encodeURIComponent(mobile)}/`, function(data) {
      renderMessages(data.messages || []);
    });
  }

  // Select contact
  $(document).on('click', '.contact-item', function () {
    selectedMobile = $(this).data('mobile');
    $('.contact-item').removeClass('active');
    $(this).addClass('active');
    $('#chatHeader').html(`<strong>${selectedMobile}</strong>`);
    $('#composer').show();
    fetchMessages(selectedMobile);
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(() => fetchMessages(selectedMobile), 4000);
  });

  // Send message
  $('#sendBtn').on('click', function () {
    const text = $('#messageInput').val().trim();
    const file = $('#mediaInput')[0].files[0];
    if (!selectedMobile) return alert("Select a contact first!");
    if (!text && !file) return alert("Type a message or select a file!");

    const formData = new FormData();
    formData.append("mobile", selectedMobile);
    if (text) formData.append("text", text);
    if (file) formData.append("media", file);

    $('#sendBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sending...');

    $.ajax({
      url: '/messaging2/api/send-reply/',
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      processData: false,
      contentType: false,
      data: formData,
      success: function () {
        $('#messageInput').val('');
        $('#mediaInput').val('');
        fetchMessages(selectedMobile);
        $('#sendBtn').prop('disabled', false).html('Send');
      },
      error: function (err) {
        alert('Error sending message: ' + (err.responseJSON?.error || 'unknown'));
        $('#sendBtn').prop('disabled', false).html('Send');
      }
    });
  });

  // Enter key to send
  $('#messageInput').on('keypress', function (e) {
    if (e.which === 13 && !e.shiftKey) {
      e.preventDefault();
      $('#sendBtn').click();
    }
  });

  // Contact search
  $('#contactSearch').on('input', function() {
    const q = $(this).val().toLowerCase();
    $('.contact-item').each(function () {
      const mobile = $(this).data('mobile').toString().toLowerCase();
      $(this).toggle(mobile.indexOf(q) !== -1);
    });
  });
})();
</script>
</body>
</html>
